.build-nvimagecodecs-docs-script: &build-nvimagecodecs-docs-script |
    python3 -m pip install artifacts/nvidia_nvimgcodecs_cuda120-*.whl
    cd docs/doxygen
    doxygen
    cd ../sphinx
    make html
    cd ../..

docs:nvimagecodecs:
    stage: build
    image: gitlab-master.nvidia.com:5005/cuda-hpc-libraries/nvimagecodec/runner-linux-x86_64:cuda-12.1.1-v2
    tags:
        - docker
    dependencies: 
        - build:nvimagecodec-cuda12
    artifacts:
        paths:
            - html
        expire_in: 2 weeks
    only:
        refs:
            - /^docs.*$/ # branch contains "docs"
    script:
        - *build-nvimagecodecs-docs-script
        - mkdir -p html
        - cp -r docs/sphinx/_build/html/* html

pages:
    stage: deploy
    image: gitlab-master.nvidia.com:5005/cuda-hpc-libraries/nvimagecodec/runner-linux-x86_64:cuda-12.1.1-v2
    tags:
        - docker
    dependencies:
        - build:nvimagecodec-cuda12
    artifacts:
        paths:
            - public
        expire_in: 1 week
    # The logic is: (any of refs) AND (any of changes)
    only:
        refs:
            - main
        changes:
            - docs/doxygen/*
            - docs/sphinx/**/*
            - docs/CMakeLists.txt
            - CMakeLists.txt
    script:
        - *build-nvimagecodecs-docs-script
        - mkdir .public
        - cp -r docs/sphinx/_build/html/* .public
        - mv .public public
