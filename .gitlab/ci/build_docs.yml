.build-nvimagecodecs-docs-script: &build-nvimagecodecs-docs-script |
    # Get build type
    source .gitlab/ci/build_type.sh
    # Build
    mkdir -p build
    cd build
    cmake -DCMAKE_BUILD_TYPE=$NVIMAGECODECS_BUILD_TYPE -DBUILD_DOCS=ON -DBUILD_TEST=OFF ..
    nice -n 19 make docs
    cd ..

docs:nvimagecodecs:
    stage: build
    tags:
        - docker
    dependencies: []
    artifacts:
        paths:
            - html
        expire_in: 2 weeks
    only:
        refs:
            - /^docs.*$/ # branch contains "docs"
    script:
        - *build-nvimagecodecs-docs-script
        - mkdir -p html
        - cp -r docs/sphinx/_build/html/* html

pages:
    stage: deploy
    tags:
        - docker
    dependencies: []
    artifacts:
        paths:
            - public
        expire_in: 1 week
    # The logic is: (any of refs) AND (any of changes)
    only:
        refs:
            - master
        changes:
            - docs/doxygen/*
            - docs/sphinx/**/*
            - docs/CMakeLists.txt
            - CMakeLists.txt
    script:
        - *build-nvimagecodecs-docs-script
        - mkdir .public
        - cp -r docs/sphinx/_build/html/* .public
        - mv .public public
